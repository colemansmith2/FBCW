# .github/workflows/weekly-update.yml
#
# Automated weekly data collection for Fantasy Baseball Civil War
# Runs every Monday at 6:00 AM ET (10:00 UTC) to collect the previous week's data
#
# Prerequisites:
# 1. Set up repository secrets (Settings > Secrets and variables > Actions):
#    - YAHOO_CONSUMER_KEY: Your Yahoo app's consumer/client key
#    - YAHOO_CONSUMER_SECRET: Your Yahoo app's consumer/client secret
#    - YAHOO_ACCESS_TOKEN: OAuth access token from initial setup
#    - YAHOO_REFRESH_TOKEN: OAuth refresh token from initial setup
#    - YAHOO_TOKEN_TIME: Timestamp when the token was issued
#    - PAT: Personal access token (for auto-updating rotated tokens)
#
# 2. The workflow will:
#    - Check out your repository
#    - Set up Python with required dependencies
#    - Pass OAuth credentials as environment variables
#    - Run the weekly stats collection script
#    - Commit and push changes back to the repository

name: Weekly Fantasy Baseball Update

on:
  # Scheduled run: Every Monday at 6:00 AM Eastern (10:00 UTC)
  # Adjust the cron schedule as needed for your timezone
  schedule:
    - cron: '0 10 * * 1'  # 10:00 UTC = 6:00 AM ET / 5:00 AM CT
  
  # Allow manual triggering from the Actions tab
  workflow_dispatch:
    inputs:
      week:
        description: 'Specific week to collect (leave empty for auto-detect)'
        required: false
        default: ''

# Permissions needed to push commits
permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. Cache pip dependencies for faster runs
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      # 4. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yahoo_oauth yahoo_fantasy_api pandas pybaseball
      
      # 5. Run the weekly stats collection
      #    Credentials are passed as env vars â€” the script builds oauth2.json internally
      - name: Collect weekly stats
        run: |
          python collect_weekly_stats.py
        env:
          TZ: America/New_York
          YAHOO_CONSUMER_KEY: ${{ secrets.YAHOO_CONSUMER_KEY }}
          YAHOO_CONSUMER_SECRET: ${{ secrets.YAHOO_CONSUMER_SECRET }}
          YAHOO_ACCESS_TOKEN: ${{ secrets.YAHOO_ACCESS_TOKEN }}
          YAHOO_REFRESH_TOKEN: ${{ secrets.YAHOO_REFRESH_TOKEN }}
          YAHOO_TOKEN_TIME: ${{ secrets.YAHOO_TOKEN_TIME }}
          GITHUB_PAT: ${{ secrets.PAT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      
      # 6. Commit and push changes
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all changed files in the data directory
          git add data/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Get current date for commit message
            DATE=$(date +'%Y-%m-%d')
            git commit -m "ðŸ“Š Weekly stats update - ${DATE}"
            git push
            echo "Changes committed and pushed successfully"
          fi
      
      # 7. Clean up sensitive files (safety net â€” script cleans up after itself)
      - name: Clean up
        if: always()
        run: |
          rm -f oauth2.json
