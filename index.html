<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Baseball Civil War</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding-top: 120px;
            /* header (70px) + nav (~50px) */
        }

        header.desktop-header {
            background: #4a5d23;
            /* Olive/brown color to match banner edges */
            padding: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
        }

        /* Mobile header - hidden on desktop */
        header.mobile-header {
            display: none;
        }

        .header-container {
            position: relative;
            display: block;
        }

        .header-banner {
            width: 100%;
            height: 70px;
            /* Adjust height for banner visibility */
            background-image: url('images/banner.png');
            /* Placeholder image for banner */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        nav {
            background-color: #f7f7f7;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: center;
        }

        .nav-container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }

        nav a {
            padding: 15px 20px;
            text-decoration: none;
            color: #1e3c72;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid transparent;
        }

        nav a:hover,
        nav a.active {
            background-color: #e0e0e0;
            color: #2a5298;
            border-bottom: 3px solid #f39c12;
            /* Accent color */
        }

        /* General content container */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .section {
            display: none;
            padding: 20px 0;
        }

        .section.active {
            display: block;
        }

        h1 {
            color: #1e3c72;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        h2 {
            color: #1e3c72;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        /* --- Standings Table Styling --- */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .standings-table,
        .player-table,
        .transaction-table,
        .manager-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .standings-table th,
        .standings-table td,
        .player-table th,
        .player-table td,
        .transaction-table th,
        .transaction-table td,
        .manager-table th,
        .manager-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .standings-table th,
        .player-table th,
        .transaction-table th,
        .manager-table th {
            background-color: #f0f0f0;
            color: #444;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .standings-table th.sortable,
        .player-table th.sortable {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .standings-table th.sortable:hover,
        .player-table th.sortable:hover {
            background-color: #e5e5e5;
        }

        .standings-table tbody tr:hover,
        .player-table tbody tr:hover,
        .transaction-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .logo-cell {
            width: 40px;
            padding-right: 5px !important;
        }

        .team-logo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            vertical-align: middle;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .team-name-cell {
            font-weight: 600;
            color: #1e3c72;
        }

        /* Standings-specific styling */
        .rank-cell {
            font-weight: bold;
            text-align: center;
        }

        .stat-col {
            text-align: right;
            font-family: monospace;
            font-size: 1em;
        }

        .manager-name {
            font-size: 0.9em;
            color: #666;
            display: block;
            margin-top: 2px;
        }

        /* Season Selector */
        .season-selector {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: inline-flex;
            gap: 10px;
            align-items: center;
            font-weight: 600;
            color: #1e3c72;
        }

        .season-selector select {
            padding: 8px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
            cursor: pointer;
        }

        /* Awards Section */
        .awards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .award-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #f39c12;
        }

        .award-card h3 {
            color: #1e3c72;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .award-details p {
            margin: 5px 0;
            color: #555;
            font-size: 0.95em;
        }

        .award-details strong {
            color: #333;
        }

        .award-value {
            font-weight: bold;
            color: #e67e22;
        }

        /* Manager Profiles */
        .manager-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .manager-card {
            background-color: #f7f7f7;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .manager-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .manager-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #f39c12;
            margin-bottom: 10px;
        }

        .manager-card h3 {
            color: #1e3c72;
            margin-bottom: 5px;
            font-size: 1.5em;
        }

        .manager-card p {
            color: #666;
            margin-bottom: 15px;
        }

        .manager-card .team-link {
            display: inline-block;
            background-color: #1e3c72;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .manager-card .team-link:hover {
            background-color: #2a5298;
        }

        /* Player Scoring Controls */
        .player-controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #eaf0f6;
            border-radius: 8px;
            border: 1px solid #dcdcdc;
        }

        .player-control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .player-controls label {
            font-weight: 600;
            color: #1e3c72;
            margin-right: 5px;
        }

        .player-controls select,
        .player-controls input[type="text"] {
            padding: 8px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
        }

        .player-search input {
            min-width: 200px;
        }

        .player-summary {
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }

        .player-name-cell {
            cursor: pointer;
            color: #2a5298;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-name-cell:hover {
            text-decoration: underline;
        }

        .player-photo-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            flex-shrink: 0;
        }

        .player-points {
            font-weight: bold;
            color: #e67e22;
        }

        /* --- Modal Styling (Player Details) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .player-modal-content {
            margin-top: 2%;
            /* Move slightly higher */
        }

        .modal-close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
            z-index: 11;
        }

        .modal-close:hover {
            color: #333;
        }

        #player-modal-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .player-modal-headshot {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
            flex-shrink: 0;
        }

        .player-modal-info {
            flex-grow: 1;
        }

        /* FIX 1: Ensure Player Name is White in Modal Header */
        #player-modal-header .player-modal-info h2 {
            color: white;
            margin: 0 0 0.25rem 0;
            font-size: 1.5rem;
        }

        .player-modal-info .player-details {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .player-modal-points {
            text-align: right;
            margin-left: auto;
            /* Push to the right */
            flex-shrink: 0;
        }

        .player-modal-points .points-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #f39c12;
            /* Accent color for points */
            line-height: 1;
        }

        .player-modal-points .points-label {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* FIX 2: Correctly position and style the Close Button for the Player Modal */
        .player-modal-close-btn {
            background: none;
            border: none;
            color: white;
            /* Makes the 'X' visible on the dark background */
            font-size: 2.5rem;
            cursor: pointer;
            padding: 0;
            margin-left: 1.5rem;
            /* Separates the X from the points display */
            transition: opacity 0.3s;
            line-height: 1;
            flex-shrink: 0;
            /* Prevents the button from shrinking */
        }

        .player-modal-close-btn:hover {
            opacity: 0.8;
        }

        .modal-body-scroll {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Responsive Styles */
        @media (max-width: 900px) {
            .nav-container {
                justify-content: flex-start;
                overflow-x: auto;
            }

            .nav-container a {
                flex-shrink: 0;
            }

            main {
                margin: 0 10px;
                padding: 15px;
            }

            .manager-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .player-control-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .player-controls select,
            .player-controls input[type="text"] {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            header.desktop-header {
                display: none;
            }

            header.mobile-header {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background-color: #4a5d23;
                z-index: 200;
                padding: 10px;
                color: white;
                text-align: center;
            }

            body {
                padding-top: 100px;
            }

            nav {
                top: 50px;
            }

            .header-banner {
                height: 40px;
                background-size: contain;
                background-repeat: repeat-x;
            }

            h1 {
                font-size: 2em;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            #player-modal-header {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .player-modal-points {
                width: 100%;
                text-align: left;
                order: 3;
                /* Move points below info block */
                margin-left: 0;
            }

            .player-modal-close-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                margin-left: 0;
                font-size: 2rem;
            }
        }

        /* Loading/Error Styles */
        .loading,
        .error {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
        }

        .loading {
            color: #2a5298;
        }

        .error {
            color: #c0392b;
            border: 1px solid #c0392b;
            background-color: #fbe6e4;
            border-radius: 5px;
        }
    </style>
</head>

<body>

    <header class="desktop-header">
        <div class="header-container">
            <div class="header-banner"></div>
        </div>
    </header>

    <header class="mobile-header">
        <h1>Fantasy Baseball Civil War</h1>
    </header>

    <nav>
        <div class="nav-container">
            <a href="#standings" class="tab-link active" data-tab="standings">Standings</a>
            <a href="#scoring" class="tab-link" data-tab="scoring">Player Scoring</a>
            <a href="#transactions" class="tab-link" data-tab="transactions">Transactions</a>
            <a href="#managers" class="tab-link" data-tab="managers">Managers</a>
            <a href="#awards" class="tab-link" data-tab="awards">Awards</a>
        </div>
    </nav>

    <main>
        <div id="standings" class="section active">
            <h2>üèÜ League Standings</h2>
            <p id="last-updated-standings">Last Updated: Loading...</p>
            <div class="season-selector">
                <label for="standings-season">Season:</label>
                <select id="standings-season" onchange="loadStandingsBySeason()">
                </select>
            </div>

            <div id="standings-loading" class="loading">Loading standings...</div>
            <div id="standings-error" class="error" style="display: none;"></div>

            <div id="standings-content" style="display: none;">
                <div class="table-wrapper">
                    <table class="standings-table" id="standings-table">
                        <thead>
                            <tr>
                                <th class="rank-cell">#</th>
                                <th class="sortable" onclick="sortStandingsTable('team_name')">Team</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('W')">W</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('L')">L</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('T')">T</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('PCT')">PCT</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('R')">R</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('HR')">HR</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('RBI')">RBI</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('SB')">SB</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('WINS')">WINS</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('K')">K</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('SAVES')">SAVES</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('ERA')">ERA</th>
                                <th class="sortable stat-col" onclick="sortStandingsTable('WHIP')">WHIP</th>
                            </tr>
                        </thead>
                        <tbody id="standings-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="scoring" class="section">
            <h2>‚öæ Player Scoring Report</h2>

            <div class="player-controls">
                <div class="player-control-row">
                    <div class="season-selector">
                        <label for="scoring-season">Season:</label>
                        <select id="scoring-season" onchange="loadPlayerScoring()">
                        </select>
                    </div>

                    <div class="position-filter">
                        <label for="position-filter">Position:</label>
                        <select id="position-filter" onchange="filterPlayers()">
                            <option value="all">All Players</option>
                            <option value="B">Batters</option>
                            <option value="P">Pitchers</option>
                            <option value="C">Catcher</option>
                            <option value="1B">1B</option>
                            <option value="2B">2B</option>
                            <option value="3B">3B</option>
                            <option value="SS">SS</option>
                            <option value="OF">OF</option>
                            <option value="DH">DH</option>
                            <option value="SP">SP</option>
                            <option value="RP">RP</option>
                        </select>
                    </div>

                    <div class="manager-filter">
                        <label for="manager-filter">Manager:</label>
                        <select id="manager-filter" onchange="filterPlayers()">
                            <option value="all">All Managers</option>
                        </select>
                    </div>

                    <div class="player-search">
                        <label for="player-search">Search Player:</label>
                        <input type="text" id="player-search" onkeyup="filterPlayers()" placeholder="Search by name...">
                    </div>
                </div>
            </div>

            <div id="player-loading" class="loading">Loading player data...</div>
            <div id="player-error" class="error" style="display: none;"></div>

            <div id="player-stats-container" style="display: none;">
                <p id="last-updated-scoring">Last Updated: Loading...</p>
                <div class="player-summary">
                    <span id="player-count">0 players</span>
                </div>

                <div class="table-wrapper player-table-wrapper">
                    <table class="player-table" id="player-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortPlayerTable('rank')">#</th>
                                <th class="sortable" onclick="sortPlayerTable('name')">Player</th>
                                <th>Team</th>
                                <th class="sortable" onclick="sortPlayerTable('positions')">Pos</th>
                                <th class="sortable stat-col" onclick="sortPlayerTable('fantasy_points')">Pts</th>
                                <th class="sortable stat-col batter-stat" onclick="sortPlayerTable('HR')">HR</th>
                                <th class="sortable stat-col batter-stat" onclick="sortPlayerTable('RBI')">RBI</th>
                                <th class="sortable stat-col batter-stat" onclick="sortPlayerTable('R')">R</th>
                                <th class="sortable stat-col batter-stat" onclick="sortPlayerTable('SB')">SB</th>
                                <th class="sortable stat-col batter-stat" onclick="sortPlayerTable('AVG')">AVG</th>
                                <th class="sortable stat-col pitcher-stat" onclick="sortPlayerTable('W')">W</th>
                                <th class="sortable stat-col pitcher-stat" onclick="sortPlayerTable('SO')">K</th>
                                <th class="sortable stat-col pitcher-stat" onclick="sortPlayerTable('ERA')">ERA</th>
                                <th class="sortable stat-col pitcher-stat" onclick="sortPlayerTable('WHIP')">WHIP</th>
                                <th class="sortable stat-col pitcher-stat" onclick="sortPlayerTable('SV')">SV</th>
                            </tr>
                        </thead>
                        <tbody id="player-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="transactions" class="section">
            <h2>üì∞ Latest Transactions</h2>
            <div class="season-selector">
                <label for="transactions-season">Season:</label>
                <select id="transactions-season" onchange="loadTransactions()">
                </select>
            </div>

            <div id="transactions-loading" class="loading">Loading transactions...</div>
            <div id="transactions-error" class="error" style="display: none;"></div>

            <div id="transactions-content" style="display: none;">
                <div class="table-wrapper">
                    <table class="transaction-table" id="transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Details</th>
                                <th>Manager</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="managers" class="section">
            <h2>üë®‚Äçüíº Manager Profiles</h2>
            <div class="manager-grid" id="manager-profiles-grid">
            </div>
            <div id="managers-error" class="error" style="display: none;"></div>
        </div>

        <div id="awards" class="section">
            <h2>üèÖ Historical Awards</h2>
            <div class="season-selector">
                <label for="awards-season">Season:</label>
                <select id="awards-season" onchange="loadAwards()">
                </select>
            </div>

            <div id="awards-loading" class="loading">Loading awards...</div>
            <div id="awards-error" class="error" style="display: none;"></div>

            <div id="awards-content" style="display: none;">

                <h3>League Leaders</h3>
                <div class="table-wrapper">
                    <table class="manager-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Category</th>
                                <th>Team</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="league-leaders-table">
                        </tbody>
                    </table>
                </div>

                <h3>Season MVP</h3>
                <div class="awards-grid" id="mvp-grid">
                </div>

                <h3>Other Season Highlights</h3>
                <div class="awards-grid" id="highlight-grid">
                </div>

            </div>
        </div>

        <div id="player-modal" class="modal">
            <div class="modal-content player-modal-content">
                <div id="player-modal-header"></div>
                <div class="modal-body-scroll" id="player-modal-body"></div>
            </div>
        </div>

    </main>

    <script>
        // =============================================================================
        // GLOBAL STATE & UTILITIES
        // =============================================================================
        const CURRENT_SEASON = 2025;
        const HISTORICAL_SEASONS = [2019, 2020, 2021, 2022, 2023, 2024];
        const DATA_DIR = 'data';

        let allPlayersData = [];
        let filteredPlayersData = [];
        let currentSortColumn = 'fantasy_points';
        let currentSortDirection = 'desc';

        // Helper to switch between sections
        function showSection(tabName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Trigger data load if necessary
            if (tabName === 'scoring' && allPlayersData.length === 0) {
                loadPlayerScoring();
            } else if (tabName === 'transactions' && document.getElementById('transactions-table-body').innerHTML === '') {
                loadTransactions();
            } else if (tabName === 'awards' && document.getElementById('league-leaders-table').innerHTML === '') {
                loadAwards();
            }
        }

        // Setup for navigation links
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = e.target.getAttribute('data-tab');
                showSection(tabName);
            });
        });

        // Initialize selectors with available seasons
        async function initializeSeasonSelectors() {
            const seasonList = [CURRENT_SEASON, ...HISTORICAL_SEASONS].sort((a, b) => b - a);
            const selectorIds = ['standings-season', 'scoring-season', 'transactions-season', 'awards-season'];

            for (const id of selectorIds) {
                const selector = document.getElementById(id);
                if (selector) {
                    selector.innerHTML = '';
                    seasonList.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === CURRENT_SEASON) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                }
            }
        }

        // Helper to format date
        function formatLastUpdated(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // =============================================================================
        // STANDINGS LOGIC
        // =============================================================================

        let allStandings = [];

        async function loadStandingsBySeason() {
            const selectedYear = document.getElementById('standings-season').value;
            const loadingEl = document.getElementById('standings-loading');
            const contentEl = document.getElementById('standings-content');
            const errorEl = document.getElementById('standings-error');
            const lastUpdatedEl = document.getElementById('last-updated-standings');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';
            lastUpdatedEl.textContent = 'Last Updated: Loading...';

            let standingsPath = `${DATA_DIR}/standings_${selectedYear}.json`;

            try {
                const response = await fetch(standingsPath);
                if (!response.ok) {
                    throw new Error(`Failed to load data from ${standingsPath}. Status: ${response.status}`);
                }
                const data = await response.json();
                allStandings = data.teams || [];
                lastUpdatedEl.textContent = `Last Updated: ${formatLastUpdated(data.updated_at)}`;

                renderStandingsTable();

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error loading standings:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = `Error loading standings: ${error.message}`;
                errorEl.style.display = 'block';
            }
        }

        function renderStandingsTable() {
            const tbody = document.getElementById('standings-table-body');
            tbody.innerHTML = '';

            allStandings.forEach((team, index) => {
                const row = tbody.insertRow();

                row.insertCell().textContent = index + 1; // Rank

                const teamCell = row.insertCell();
                teamCell.classList.add('team-name-cell');
                teamCell.innerHTML = `
                    <img src="${team.logo_url}" alt="${team.team_name} logo" class="team-logo">
                    ${team.team_name}
                    <span class="manager-name">${team.manager}</span>
                `;

                row.insertCell().textContent = team.W || 0;
                row.insertCell().textContent = team.L || 0;
                row.insertCell().textContent = team.T || 0;
                row.insertCell().textContent = team.PCT ? team.PCT.toFixed(3) : '0.000';

                // Stat columns
                row.insertCell().textContent = team.stats.R || 0;
                row.insertCell().textContent = team.stats.HR || 0;
                row.insertCell().textContent = team.stats.RBI || 0;
                row.insertCell().textContent = team.stats.SB || 0;
                row.insertCell().textContent = team.stats.WINS || 0;
                row.insertCell().textContent = team.stats.K || 0;
                row.insertCell().textContent = team.stats.SAVES || 0;
                row.insertCell().textContent = team.stats.ERA ? team.stats.ERA.toFixed(2) : '0.00';
                row.insertCell().textContent = team.stats.WHIP ? team.stats.WHIP.toFixed(2) : '0.00';
            });
        }

        function sortStandingsTable(column) {
            // No current implementation for sorting standings, but this is the hook
            console.log(`Sorting standings by ${column}`);
        }

        // =============================================================================
        // PLAYER SCORING LOGIC
        // =============================================================================

        async function loadPlayerScoring() {
            const selectedYear = document.getElementById('scoring-season').value;
            const loadingEl = document.getElementById('player-loading');
            const contentEl = document.getElementById('player-stats-container');
            const errorEl = document.getElementById('player-error');
            const lastUpdatedEl = document.getElementById('last-updated-scoring');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';
            lastUpdatedEl.textContent = 'Last Updated: Loading...';

            let playerStatsPath;
            if (parseInt(selectedYear) === CURRENT_SEASON) {
                playerStatsPath = `${DATA_DIR}/current_season/player_stats.json`;
            } else {
                playerStatsPath = `${DATA_DIR}/historical/${selectedYear}/player_stats.json`;
            }

            try {
                const response = await fetch(playerStatsPath);
                if (!response.ok) {
                    throw new Error(`Failed to load player data from ${playerStatsPath}. Status: ${response.status}`);
                }
                const data = await response.json();
                allPlayersData = data.players || [];
                lastUpdatedEl.textContent = `Last Updated: ${formatLastUpdated(data.updated_at)}`;

                // Add manager names to filter list if not already there
                populateManagerFilter(allPlayersData.map(p => p.team_name).filter((v, i, a) => a.indexOf(v) === i));

                filterPlayers(); // Initial filter and render

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error loading player scoring data:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = `Error loading player data: ${error.message}`;
                errorEl.style.display = 'block';
            }
        }

        function populateManagerFilter(managerNames) {
            const managerFilter = document.getElementById('manager-filter');
            // Save current value
            const currentValue = managerFilter.value;

            // Clear all options except 'All Managers'
            managerFilter.innerHTML = '<option value="all">All Managers</option>';

            managerNames.sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                managerFilter.appendChild(option);
            });

            // Restore previous value if it still exists
            if (managerNames.includes(currentValue) || currentValue === 'all') {
                managerFilter.value = currentValue;
            }
        }

        function filterPlayers() {
            const positionFilter = document.getElementById('position-filter').value;
            const managerFilter = document.getElementById('manager-filter').value;
            const searchInput = document.getElementById('player-search').value.toLowerCase();

            filteredPlayersData = allPlayersData.filter(player => {
                const positionMatch = positionFilter === 'all' ||
                    (positionFilter === 'B' && player.position_type === 'B') ||
                    (positionFilter === 'P' && player.position_type === 'P') ||
                    player.positions.includes(positionFilter);

                const managerMatch = managerFilter === 'all' || player.team_name === managerFilter;

                const searchMatch = searchInput === '' || player.name.toLowerCase().includes(searchInput);

                return positionMatch && managerMatch && searchMatch;
            });

            sortPlayerTable(currentSortColumn, currentSortDirection, false); // Sort and render
            document.getElementById('player-count').textContent = `${filteredPlayersData.length} players shown`;
        }

        function sortPlayerTable(column, direction = null, toggle = true) {
            if (toggle) {
                if (column === currentSortColumn) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = column;
                    currentSortDirection = direction || (column === 'name' ? 'asc' : 'desc');
                }
            } else {
                currentSortColumn = column;
                currentSortDirection = direction;
            }

            // Update table headers for visual cue
            document.querySelectorAll('#player-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick')?.includes(`'${currentSortColumn}'`)) {
                    th.classList.add(`sort-${currentSortDirection}`);
                }
            });

            // Sorting logic
            filteredPlayersData.sort((a, b) => {
                let aVal, bVal;

                // Special cases for top-level keys
                if (column === 'name' || column === 'team_name' || column === 'positions' || column === 'rank') {
                    aVal = a[column] || '';
                    bVal = b[column] || '';
                } else if (column === 'fantasy_points') {
                    aVal = a.fantasy_points || 0;
                    bVal = b.fantasy_points || 0;
                } else { // Stat column (e.g., HR, ERA, W)
                    aVal = (a.stats && a.stats[column]) || 0;
                    bVal = (b.stats && b.stats[column]) || 0;
                }

                // Handle text vs. numeric sorting
                if (typeof aVal === 'string' || typeof bVal === 'string') {
                    return currentSortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }
            });

            renderPlayerTable();
        }


        function renderPlayerTable() {
            const tbody = document.getElementById('player-table-body');
            tbody.innerHTML = '';

            tbody.innerHTML = filteredPlayersData.map((player, index) => {
                const stats = player.stats || {};
                const isBatter = player.position_type === 'B';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="player-name-cell" onclick="showPlayerDetail('${player.name}')">
                            <img src="${player.headshot_base64_small}" alt="${player.name}" class="player-photo-small">
                            ${player.name}
                        </td>
                        <td>${player.team_name}</td>
                        <td>${player.positions}</td>
                        
                        <td class="player-points">${(player.fantasy_points || 0).toFixed(1)}</td>
                        
                        <td class="stat-col batter-stat">${isBatter ? (stats.HR || 0) : '-'}</td>
                        <td class="stat-col batter-stat">${isBatter ? (stats.RBI || 0) : '-'}</td>
                        <td class="stat-col batter-stat">${isBatter ? (stats.R || 0) : '-'}</td>
                        <td class="stat-col batter-stat">${isBatter ? (stats.SB || 0) : '-'}</td>
                        <td class="stat-col batter-stat">${isBatter ? (stats.AVG ? stats.AVG.toFixed(3) : '-') : '-'}</td>
                        
                        <td class="stat-col pitcher-stat">${!isBatter ? (stats.W || 0) : '-'}</td>
                        <td class="stat-col pitcher-stat">${!isBatter ? (stats.SO || 0) : '-'}</td>
                        <td class="stat-col pitcher-stat">${!isBatter ? (stats.ERA ? stats.ERA.toFixed(2) : '-') : '-'}</td>
                        <td class="stat-col pitcher-stat">${!isBatter ? (stats.WHIP ? stats.WHIP.toFixed(2) : '-') : '-'}</td>
                        <td class="stat-col pitcher-stat">${!isBatter ? (stats.SV || 0) : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // =============================================================================
        // PLAYER MODAL LOGIC (Details)
        // =============================================================================

        function showPlayerDetail(playerName) {
            const player = allPlayersData.find(p => p.name === playerName);
            if (!player) return;

            const modal = document.getElementById('player-modal');
            const headerEl = document.getElementById('player-modal-header');
            const bodyEl = document.getElementById('player-modal-body');

            // --- HEADER RENDERING (FIXED FOR COLOR/OVERLAP) ---
            headerEl.innerHTML = `
                <img src="${player.headshot_base64_white}" alt="${player.name}" class="player-modal-headshot">
                <div class="player-modal-info">
                    <h2>${player.name}</h2>
                    <div class="player-details">
                        <span>${player.mlb_team}</span>
                        <span>|</span>
                        <span>${player.positions} (${player.position_type === 'B' ? 'Batter' : 'Pitcher'})</span>
                        <span>|</span>
                        <span>${player.team_name}</span>
                    </div>
                </div>
                <div class="player-modal-points">
                    <div class="points-value">${(player.fantasy_points || 0).toFixed(1)}</div>
                    <div class="points-label">Total Pts</div>
                </div>
                <button class="player-modal-close-btn" onclick="closePlayerDetail()">&times;</button>
            `;
            // --- END HEADER RENDERING ---

            // --- BODY RENDERING ---
            const stats = player.stats || {};
            const isBatter = player.position_type === 'B';

            let statsHtml = '<h3>Fantasy Stats Breakdown</h3>';

            if (isBatter) {
                statsHtml += `
                    <div class="stats-grid">
                        <p><strong>HR:</strong> ${stats.HR || 0}</p>
                        <p><strong>RBI:</strong> ${stats.RBI || 0}</p>
                        <p><strong>R:</strong> ${stats.R || 0}</p>
                        <p><strong>SB:</strong> ${stats.SB || 0}</p>
                        <p><strong>AVG:</strong> ${(stats.AVG || 0).toFixed(3)}</p>
                        <p><strong>H:</strong> ${stats.H || 0}</p>
                        <p><strong>BB:</strong> ${stats.BB || 0}</p>
                        <p><strong>SO:</strong> ${stats.SO || 0}</p>
                        <p><strong>OPS:</strong> ${(stats.OPS || 0).toFixed(3)}</p>
                    </div>
                `;
            } else {
                statsHtml += `
                    <div class="stats-grid">
                        <p><strong>W:</strong> ${stats.W || 0}</p>
                        <p><strong>SO:</strong> ${stats.SO || 0}</p>
                        <p><strong>SV:</strong> ${stats.SV || 0}</p>
                        <p><strong>HLD:</strong> ${stats.HLD || 0}</p>
                        <p><strong>ERA:</strong> ${(stats.ERA || 0).toFixed(2)}</p>
                        <p><strong>WHIP:</strong> ${(stats.WHIP || 0).toFixed(2)}</p>
                        <p><strong>IP:</strong> ${(stats.IP || 0).toFixed(1)}</p>
                        <p><strong>ER:</strong> ${stats.ER || 0}</p>
                        <p><strong>QS:</strong> ${stats.QS || 0}</p>
                    </div>
                `;
            }

            bodyEl.innerHTML = statsHtml;
            // --- END BODY RENDERING ---

            modal.style.display = 'block';
        }

        function closePlayerDetail() {
            document.getElementById('player-modal').style.display = 'none';
        }

        // Close modal when user clicks outside of it
        window.onclick = function (event) {
            const modal = document.getElementById('player-modal');
            if (event.target === modal) {
                closePlayerDetail();
            }
        }

        // =============================================================================
        // TRANSACTIONS LOGIC
        // =============================================================================

        async function loadTransactions() {
            const selectedYear = document.getElementById('transactions-season').value;
            const loadingEl = document.getElementById('transactions-loading');
            const contentEl = document.getElementById('transactions-content');
            const errorEl = document.getElementById('transactions-error');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';

            let transactionsPath;
            if (parseInt(selectedYear) === CURRENT_SEASON) {
                transactionsPath = `${DATA_DIR}/current_season/transactions.json`;
            } else {
                transactionsPath = `${DATA_DIR}/historical/${selectedYear}/transactions.json`;
            }

            try {
                const response = await fetch(transactionsPath);
                if (!response.ok) {
                    throw new Error(`Failed to load data from ${transactionsPath}. Status: ${response.status}`);
                }
                const data = await response.json();
                const transactions = data.transactions || [];

                renderTransactionsTable(transactions);

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error loading transactions:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = `Error loading transactions: ${error.message}`;
                errorEl.style.display = 'block';
            }
        }

        function renderTransactionsTable(transactions) {
            const tbody = document.getElementById('transactions-table-body');
            tbody.innerHTML = '';

            transactions.forEach(tx => {
                const row = tbody.insertRow();
                row.insertCell().textContent = tx.date;
                row.insertCell().textContent = tx.type;
                row.insertCell().textContent = tx.details;
                row.insertCell().textContent = tx.manager_name;
            });
        }

        // =============================================================================
        // MANAGER PROFILES LOGIC
        // =============================================================================

        async function loadManagerProfiles() {
            const loadingEl = document.getElementById('managers-error'); // Using error element for simple loading message
            loadingEl.textContent = 'Loading manager data...';
            loadingEl.style.display = 'block';

            const managersPath = `${DATA_DIR}/current_season/managers.json`;

            try {
                const response = await fetch(managersPath);
                if (!response.ok) {
                    throw new Error(`Failed to load manager data from ${managersPath}. Status: ${response.status}`);
                }
                const data = await response.json();
                const managers = data.managers || [];

                renderManagerCards(managers);

                loadingEl.style.display = 'none';

            } catch (error) {
                console.error('Error loading manager profiles:', error);
                loadingEl.textContent = `Error loading manager profiles: ${error.message}`;
                loadingEl.style.display = 'block';
            }
        }

        function renderManagerCards(managers) {
            const grid = document.getElementById('manager-profiles-grid');
            grid.innerHTML = managers.map(manager => `
                <div class="manager-card">
                    <img src="${manager.logo_url}" alt="${manager.team_name} logo">
                    <h3>${manager.manager_name}</h3>
                    <p>${manager.team_name}</p>
                    <a href="${manager.team_url}" target="_blank" class="team-link">View Team Page</a>
                </div>
            `).join('');
        }

        // =============================================================================
        // AWARDS LOGIC
        // =============================================================================

        async function loadAwards() {
            const selectedYear = document.getElementById('awards-season').value;
            const loadingEl = document.getElementById('awards-loading');
            const contentEl = document.getElementById('awards-content');
            const errorEl = document.getElementById('awards-error');

            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            errorEl.style.display = 'none';

            let awardsPath = `${DATA_DIR}/historical/${selectedYear}/awards.json`;

            if (parseInt(selectedYear) === CURRENT_SEASON) {
                // Current season awards might not be generated yet, use a placeholder or check current season path
                awardsPath = `${DATA_DIR}/current_season/awards.json`;
            }

            try {
                const response = await fetch(awardsPath);
                if (!response.ok) {
                    throw new Error(`Failed to load awards data from ${awardsPath}. Status: ${response.status}`);
                }
                const data = await response.json();

                populateAwardTable('league-leaders-table', data.leaders || [], award => `
                    <td class="rank-cell">${award.rank}</td>
                    <td><strong>${award.stat_category}</strong></td>
                    <td>${award.team_name}</td>
                    <td><span class="award-value">${award.value.toLocaleString()}</span></td>
                `);

                // Assuming MVP and Highlight data uses a similar, simpler structure
                // We'll just show the same data for all sections as a placeholder
                populateAwardTable('mvp-grid', data.mvp_candidates || [], award => `
                    <div class="award-card">
                        <h3>${award.stat_category}</h3>
                        <div class="award-details">
                            <p><strong>Team:</strong> ${award.team_name}</p>
                            <p><strong>Value:</strong> <span class="award-value">${award.value.toLocaleString()}</span></p>
                        </div>
                    </div>
                `);

                populateAwardTable('highlight-grid', data.highlights || [], award => `
                    <div class="award-card">
                        <h3>${award.stat_category}</h3>
                        <div class="award-details">
                            <p><strong>Team:</strong> ${award.team_name}</p>
                            <p><strong>Value:</strong> <span class="award-value">${award.value.toLocaleString()}</span></p>
                        </div>
                    </div>
                `);

                console.log("Awards populated successfully");
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error loading awards:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = `Error loading awards: ${error.message}`;
                errorEl.style.display = 'block';
            }
        }

        function populateAwardTable(tableId, awards, rowTemplate) {
            const container = document.getElementById(tableId);
            container.innerHTML = '';

            if (tableId.includes('grid')) {
                // Render as grid items
                container.innerHTML = awards.map(rowTemplate).join('');
            } else {
                // Render as table rows
                awards.forEach(award => {
                    const row = document.createElement('tr');
                    row.innerHTML = rowTemplate(award);
                    container.appendChild(row);
                });
            }
        }

        // ===== INITIALIZE ON PAGE LOAD =====
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize season selectors (detect available seasons)
            await initializeSeasonSelectors();

            // Load current season standings by default
            loadStandingsBySeason();

            // Load manager profiles
            loadManagerProfiles();
        });
    </script>
</body>

</html>